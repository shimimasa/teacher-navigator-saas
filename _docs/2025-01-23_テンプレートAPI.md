# 2025-01-23 テンプレートAPIとカスタマイズ機能の実装

## 実施内容

### 1. テンプレートAPIルート（routes/template.js）

#### 実装エンドポイント
- `POST /api/templates/generate` - テンプレート生成（要認証）
- `GET /api/templates` - ユーザーのテンプレート一覧（要認証）
- `GET /api/templates/public` - 公開テンプレート検索（公開）
- `GET /api/templates/popular` - 人気テンプレート（公開）
- `GET /api/templates/search` - キーワード検索（要認証）
- `GET /api/templates/:id` - テンプレート詳細（権限による）
- `PUT /api/templates/:id` - テンプレート更新（所有者のみ）
- `DELETE /api/templates/:id` - テンプレートアーカイブ（所有者のみ）
- `POST /api/templates/:id/duplicate` - テンプレート複製（要認証）
- `GET /api/templates/:id/download` - PDF ダウンロード（権限による）
- `POST /api/templates/:id/preview` - プレビュー生成（所有者のみ）
- `POST /api/templates/:id/share` - 共有設定更新（所有者のみ）
- `POST /api/templates/:id/feedback` - フィードバック送信（要認証）

### 2. バリデーションミドルウェア（middleware/templateValidation.js）

#### バリデーション実装
- **テンプレート生成**: 必須フィールド、データ型、範囲チェック
- **テンプレート更新**: 部分更新対応、活動時間の妥当性検証
- **クエリパラメータ**: ページネーション、フィルタリング
- **複製**: タイトル必須、変更内容の検証
- **フィードバック**: 評価範囲、効果性指標
- **共有設定**: ユーザーID形式、権限レベル

#### セキュリティ対策
- XSS対策（コメントのエスケープ）
- MongoDBインジェクション対策
- 入力値の厳密な型チェック

### 3. API機能の詳細

#### テンプレート生成（POST /api/templates/generate）
- 診断結果と授業スタイルから自動生成
- カスタマイズオプションの適用
- パーソナリティタイプに最適化されたコンテンツ

#### 一覧・検索機能
- **個人テンプレート**: ステータス、タイプ、教科でフィルター
- **公開テンプレート**: 人気順、タグ検索対応
- **キーワード検索**: タイトル、教科、タグを横断検索

#### 編集・カスタマイズ機能
- **部分更新**: 必要なフィールドのみ更新可能
- **バージョン管理**: 更新時に自動でバージョンアップ
- **活動時間検証**: 授業時間を超えないよう自動チェック

#### 共有・コラボレーション機能
- **公開設定**: 全体公開/非公開の切り替え
- **個別共有**: 最大50人まで個別共有可能
- **権限管理**: view/edit の2段階権限
- **複製機能**: 公開テンプレートを基に独自版作成

#### PDF生成・ダウンロード
- **リアルタイム生成**: 最新の内容でPDF作成
- **プレビュー機能**: Base64エンコードで即時確認
- **ダウンロード追跡**: 統計情報の自動更新
- **ファイル管理**: 生成履歴の保存

#### フィードバック・評価システム
- **5段階評価**: シンプルな満足度評価
- **効果性指標**: 4つの観点から詳細評価
  - 生徒の参加度
  - 学習成果
  - 時間管理
  - 全体的な成功度
- **コメント機能**: 500文字までの自由記述

### 4. アクセス制御

#### 権限レベル
1. **所有者**: 全機能へのアクセス（編集、削除、共有設定）
2. **共有ユーザー**: 閲覧、ダウンロード（編集権限の場合は更新も可）
3. **一般ユーザー**: 公開テンプレートの閲覧、ダウンロード、複製
4. **未認証**: 公開テンプレートの一覧表示のみ

#### 自動処理
- 閲覧数カウント（所有者以外のアクセス時）
- ダウンロード数カウント（全ユーザー）
- 最終使用日時の更新

### 5. 統合テスト（__tests__/routes/template.test.js）

#### テストカバレッジ
- 全エンドポイントの正常系
- 権限チェック（所有者、共有、公開）
- バリデーションエラー
- PDF生成とプレビュー
- フィードバック機能
- 検索と絞り込み

### 6. サーバー設定の更新

#### server.jsの変更
- テンプレートAPIルートを追加
- `/api/templates`エンドポイントの有効化

## 技術的決定事項

### APIレスポンス構造
- 一覧系: ページネーション情報を含む
- 詳細系: 権限情報を含む
- 生成系: 生成IDと概要を返却

### パフォーマンス最適化
- 概要表示用メソッドで軽量化
- 必要最小限のpopulate
- インデックスを活用した検索

### セキュリティ設計
- 所有者確認の徹底
- 公開/非公開の厳密な制御
- センシティブ情報（回答キー等）の除外

## API使用例

### テンプレート生成
```bash
POST /api/templates/generate
{
  "diagnosisId": "xxx",
  "teachingStyleId": "yyy",
  "title": "中1数学 方程式入門",
  "subject": "数学",
  "gradeLevel": "中学1年",
  "duration": 50,
  "templateType": "comprehensive"
}
```

### 公開テンプレート検索
```bash
GET /api/templates/public?subject=数学&gradeLevel=中学1年&tags=方程式,基礎
```

### PDF ダウンロード
```bash
GET /api/templates/:id/download
→ レスポンス: { url: "/uploads/pdfs/xxx.pdf", filename: "xxx.pdf", size: 12345 }
```

### 共有設定更新
```bash
POST /api/templates/:id/share
{
  "isPublic": true,
  "sharedWith": [
    { "userId": "xxx", "permission": "view" },
    { "userId": "yyy", "permission": "edit" }
  ]
}
```

## 次のステップ
- フロントエンド基盤構築（タスク6.1）
- React プロジェクトのセットアップ
- 基本的なコンポーネント構造の実装
- APIとの連携準備