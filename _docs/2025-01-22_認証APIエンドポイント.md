# 2025-01-22 認証APIエンドポイントの実装

## 実施内容

### 1. 認証ルートの実装（routes/auth.js）

#### 実装したエンドポイント
- `POST /api/auth/register` - ユーザー登録
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `POST /api/auth/reset-password/request` - パスワードリセット要求
- `POST /api/auth/reset-password` - パスワードリセット実行
- `GET /api/auth/me` - 現在のユーザー情報取得
- `PUT /api/auth/profile` - プロフィール更新
- `PUT /api/auth/password` - パスワード変更
- `DELETE /api/auth/account` - アカウント削除（無効化）
- `GET /api/auth/verify` - トークン検証（ヘルスチェック用）

#### セキュリティ対策
- レート制限の実装
  - ログイン: 15分間に5回まで
  - 登録: 1時間に3回まで
- バリデーションミドルウェアの適用
- 認証が必要なエンドポイントには`protect`ミドルウェアを適用

### 2. メインサーバーファイルの更新（server.js）
- 認証ルートを`/api/auth`に接続

### 3. メールサービスの実装（services/emailService.js）

#### 実装機能
- 基本的なメール送信機能
- パスワードリセットメール
- ウェルカムメール
- アカウント削除確認メール

#### 開発環境対応
- 開発環境ではEthereal Email（テスト用SMTPサービス）を使用
- プレビューURLをコンソールに表示
- 本番環境では環境変数で設定したSMTPサーバーを使用

### 4. 統合テストの実装（__tests__/routes/auth.test.js）

#### テストケース
- ユーザー登録の成功・失敗ケース
- ログインの成功・失敗ケース
- 認証が必要なエンドポイントのアクセス制御
- プロフィール更新
- パスワード変更
- パスワードリセットフロー
- アカウント削除

#### テストカバレッジ
- 正常系・異常系の両方をカバー
- バリデーションエラーのテスト
- 認証エラーのテスト

## APIレスポンス形式

### 成功時
```json
{
  "success": true,
  "message": "操作に関するメッセージ",
  "data": {
    // レスポンスデータ
  }
}
```

### エラー時
```json
{
  "success": false,
  "error": {
    "message": "エラーメッセージ",
    "details": [
      {
        "field": "フィールド名",
        "message": "詳細エラーメッセージ"
      }
    ]
  }
}
```

## 技術的決定事項
- ログアウトはクライアント側でトークンを削除する方式を採用
- パスワードリセットトークンの有効期限は1時間
- メール送信失敗時もユーザーには成功レスポンスを返す（セキュリティ対策）
- アカウント削除は物理削除ではなく論理削除（isActive = false）

## セキュリティ考慮事項
- レート制限でブルートフォース攻撃を防止
- パスワードリセット要求時、メールアドレスの存在有無を隠蔽
- すべての機密情報をレスポンスから除外
- 詳細なバリデーションエラーメッセージ

## 次のステップ
- 診断データモデルと質問管理（タスク3.1）
- 診断機能の実装に向けた準備