# 2025-01-23 テンプレートモデルとPDF生成機能の実装

## 実施内容

### 1. Templateモデル（models/Template.js）

#### 主要機能
- 授業計画、ワークシート、評価基準の包括的なデータ管理
- 4種類のテンプレートタイプ（lesson_plan, worksheet, assessment, comprehensive）
- カスタマイズ設定（フォントサイズ、配色、特別支援対応）
- バージョン管理と共有機能
- 使用統計とフィードバック管理

#### データ構造
- **基本情報**: タイトル、教科、学年、授業時間
- **コンテンツ**: 
  - 授業計画（概要、目標、教材、活動、宿題）
  - ワークシート（指示、問題、配点）
  - 評価基準（タイプ、基準、ルーブリック）
- **メタデータ**: バージョン、タグ、生成ファイル、共有設定
- **使用統計**: 閲覧数、ダウンロード数、評価

#### 実装メソッド
- `getSummary()` - テンプレート概要の取得
- `getPublicView()` - 公開用ビューの生成
- `incrementViewCount()` - 閲覧数の増加
- `incrementDownloadCount()` - ダウンロード数の増加
- `addGeneratedFile()` - 生成ファイルの追加
- `updateVersion()` - バージョン更新

#### 静的メソッド
- `findByUser()` - ユーザー別検索
- `findPublicTemplates()` - 公開テンプレート検索
- `getPopularTemplates()` - 人気テンプレート取得
- `searchTemplates()` - キーワード検索

### 2. PDF生成サービス（services/pdfGenerator.js）

#### 主要機能
- PDFKitを使用した高品質PDF生成
- 日本語フォント対応（NotoSansJP想定）
- カスタマイズ可能なレイアウトとスタイル
- テンプレートタイプ別の最適化されたフォーマット

#### PDF生成プロセス
1. **ヘッダー生成**: タイトル、教科、学年、時間
2. **コンテンツ生成**: 
   - 授業計画: 概要、目標、教材、活動の流れ、宿題
   - ワークシート: 指示、問題、回答スペース、配点
   - 評価基準: 評価タイプ、基準表、ルーブリック
3. **フッター生成**: ページ番号、作成日、サービス名

#### カスタマイズ機能
- **フォントサイズ**: small, medium, large
- **配色スキーム**: default, high_contrast, colorful, minimal
- **特別支援対応**: 視覚、聴覚、学習困難への配慮

#### 特殊機能
- 回答スペースの自動生成（問題タイプ別）
- ページネーション管理
- プレビューPDF生成（メモリ内処理）

### 3. テンプレート生成サービス（services/templateGenerator.js）

#### 主要機能
- 診断結果と授業スタイルに基づく自動生成
- パーソナリティタイプを考慮したコンテンツ最適化
- 既存テンプレートの複製とカスタマイズ

#### 生成アルゴリズム
1. **授業計画生成**:
   - スタイル特性に応じた活動構成
   - 時間配分の自動計算
   - パーソナリティタイプに適した指導方法

2. **ワークシート生成**:
   - 難易度の段階的調整
   - 問題タイプの多様化
   - ヒント機能の実装

3. **評価基準生成**:
   - スタイルに応じた評価観点
   - 4段階評価レベル
   - フィードバックガイドライン

#### スタイル別の特徴
- **構造化ファシリテーター型**: 体系的、段階的な構成
- **創造的探求者型**: オープンエンド、探究的な活動
- **体系的指導者型**: 基礎から応用への着実な展開
- **共感的メンター型**: 個別配慮、柔軟な対応
- **ダイナミック実演型**: エネルギッシュ、実演中心
- **分析的コーチ型**: データ活用、論理的思考
- **協働的組織者型**: グループワーク、相互学習
- **実践的実証型**: 体験学習、実用的スキル

### 4. テストの実装

#### Templateモデルテスト
- CRUD操作の検証
- バリデーションルール
- 仮想プロパティの動作
- 静的メソッドの機能
- 自動計算機能（合計点数など）

### 5. パッケージ依存関係の更新

#### 追加した依存関係
- `mkdirp`: ディレクトリ作成ユーティリティ（PDF保存用）

## 技術的決定事項

### データモデル設計
- 柔軟なコンテンツ構造で多様な授業形態に対応
- バージョン管理で更新履歴を保持
- 共有機能で教員間の知識共有を促進

### PDF生成
- サーバーサイドでの生成で一貫性を確保
- ストリーミング処理でメモリ効率を最適化
- エラー時の自動クリーンアップ

### テンプレート生成
- AIライクな推奨アルゴリズム
- 教育理論に基づいた活動設計
- カスタマイズ性と使いやすさのバランス

## セキュリティ考慮事項
- ファイルアクセス権限の適切な管理
- 生成ファイルの一時保存とクリーンアップ
- ユーザー間のデータ分離

## パフォーマンス最適化
- インデックスによるクエリ高速化
- PDF生成の非同期処理
- キャッシュ可能なデータ構造

## 次のステップ
- テンプレートAPIとカスタマイズ機能の実装（タスク5.2）
- エンドポイントの定義とルーティング
- フロントエンドとの連携準備
- 日本語フォントファイルの配置