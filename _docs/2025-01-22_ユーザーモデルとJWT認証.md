# 2025-01-22 ユーザーモデルとJWT認証の実装

## 実施内容

### 1. Userモデルの実装（models/User.js）

#### スキーマ定義
- メールアドレス（一意制約、形式バリデーション）
- パスワード（bcryptでハッシュ化、最小8文字）
- プロフィール情報（名前、学校、教科、経験年数）
- ロール（teacher/admin）
- パスワードリセット用フィールド
- アカウント状態（isActive）

#### メソッド実装
- `comparePassword()` - パスワード検証
- `getJWTPayload()` - JWTペイロード生成
- `getPublicProfile()` - 公開プロフィール取得
- `generatePasswordResetToken()` - パスワードリセットトークン生成

#### セキュリティ対策
- パスワードの自動ハッシュ化（save前のミドルウェア）
- JSONレスポンスから機密情報を除外
- インデックスの設定でクエリパフォーマンス向上

### 2. JWT認証ミドルウェア（middleware/auth.js）

#### 実装機能
- `generateToken()` - JWTトークン生成
- `verifyToken()` - トークン検証
- `protect` - 認証必須エンドポイント用ミドルウェア
- `authorize()` - ロールベースアクセス制御
- `optionalAuth` - オプショナル認証
- `rateLimit()` - レート制限（簡易版）

#### セキュリティ機能
- Bearer トークン形式での認証
- トークン有効期限チェック
- アクティブユーザーチェック
- 詳細なエラーメッセージ

### 3. 認証サービス（services/authService.js）

#### 実装メソッド
- `register()` - ユーザー登録
- `login()` - ログイン認証
- `requestPasswordReset()` - パスワードリセット要求
- `resetPassword()` - パスワードリセット実行
- `updateProfile()` - プロフィール更新
- `changePassword()` - パスワード変更
- `deleteAccount()` - アカウント無効化（論理削除）

#### ビジネスロジック
- メールアドレス重複チェック
- 最終ログイン時刻の更新
- セキュアなエラーレスポンス（情報漏洩防止）

### 4. バリデーションミドルウェア（middleware/validation.js）

#### バリデーションルール
- ユーザー登録（メール形式、パスワード強度、必須項目）
- ログイン（メール、パスワード）
- パスワードリセット（トークン、新パスワード）
- プロフィール更新（文字数制限、形式チェック）

#### セキュリティ機能
- 入力値のサニタイズ
- XSS対策（HTMLタグ除去）
- 詳細なエラーメッセージ

### 5. テストの実装

#### Userモデルテスト（__tests__/models/User.test.js）
- ユーザー作成の成功・失敗ケース
- バリデーションテスト
- パスワードハッシュ化の確認
- 各メソッドの動作確認

#### 認証ミドルウェアテスト（__tests__/middleware/auth.test.js）
- トークン生成・検証
- 認証ミドルウェアの各種ケース
- ロールベースアクセス制御
- レート制限機能

## 次のステップ
- 認証APIエンドポイントの実装（タスク2.2）
- 実際のルート定義とコントローラー実装

## 技術的決定事項
- bcryptのソルトラウンド数: 10（セキュリティとパフォーマンスのバランス）
- JWT有効期限: 7日間（環境変数で設定可能）
- パスワードリセットトークン有効期限: 1時間
- アカウント削除: 物理削除ではなく論理削除（isActive = false）

## セキュリティ考慮事項
- パスワードは常にハッシュ化して保存
- JWTシークレットは環境変数で管理
- レート制限でブルートフォース攻撃を防止
- エラーメッセージで情報漏洩を防止（例：ユーザー存在確認）